{% extends 'base.html' %}

{% block title %}Calendar - Project Tracker{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-calendar-alt me-1"></i>Calendar
</li>
{% endblock %}

{% block content %}
<div class="calendar-header mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="calendar-title">
                <i class="fas fa-calendar-alt text-primary me-3"></i>
                Calendar
            </h1>
            <p class="text-muted">View your project timeline and deadlines.</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Event
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Project Calendar</h5>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 700,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        events: fetchCalendarEvents,
        eventClick: function(info) {
            if (info.event.url) {
                window.open(info.event.url, '_blank');
                info.jsEvent.preventDefault();
            }
        },
        eventDisplay: 'block',
    });
    calendar.render();
});

function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
    Promise.all([
        fetch('/api/projects/projects/').then(r => r.json()),
        fetch('/api/tasks/tasks/').then(r => r.json())
    ]).then(([projects, tasks]) => {
        let events = [];
        (projects.results || projects).forEach(project => {
            if (project.start_date) {
                events.push({
                    title: `[Project Start] ${project.name}`,
                    start: project.start_date,
                    color: '#1976d2',
                    url: `/projects/${project.id}/`
                });
            }
            if (project.estimated_completion_date) {
                events.push({
                    title: `[Project Due] ${project.name}`,
                    start: project.estimated_completion_date,
                    color: '#388e3c',
                    url: `/projects/${project.id}/`
                });
            }
            if (project.end_date) {
                events.push({
                    title: `[Project End] ${project.name}`,
                    start: project.end_date,
                    color: '#d32f2f',
                    url: `/projects/${project.id}/`
                });
            }
        });
        (tasks.results || tasks).forEach(task => {
            if (task.start_date) {
                events.push({
                    title: `[Task Start] ${task.title}`,
                    start: task.start_date,
                    color: '#0288d1',
                    url: `/tasks/?project=${task.project}`
                });
            }
            if (task.due_date) {
                events.push({
                    title: `[Task Due] ${task.title}`,
                    start: task.due_date,
                    color: '#fbc02d',
                    url: `/tasks/?project=${task.project}`
                });
            }
            if (task.completed_date) {
                events.push({
                    title: `[Task Completed] ${task.title}`,
                    start: task.completed_date,
                    color: '#43a047',
                    url: `/tasks/?project=${task.project}`
                });
            }
        });
        successCallback(events);
    }).catch(failureCallback);
}
</script>

<style>
.calendar-header {
    background: linear-gradient(135deg, #81bef3  0%, #495057 100%);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    margin-top: -1rem;
}

.calendar-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
    .calendar-header {
        padding: 1.5rem;
        margin-top: 0;
    }
    
    .calendar-title {
        font-size: 2rem;
    }
}
</style>
{% endblock %} 